<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Tracker Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            background-color: #020617;
        }
        
        #sidebar {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 260px;
        }
        
        .sidebar-hidden #sidebar {
            width: 0;
            transform: translateX(-100%);
            opacity: 0;
            pointer-events: none;
        }

        #expand-sidebar { display: none; }
        .sidebar-hidden #expand-sidebar { display: flex; }

        .sidebar-link.active {
            background-color: #1e293b;
            border-left: 4px solid #eab308;
            color: #facc15;
        }
        .sidebar-link.active i { color: #facc15; }

        .chrome-tab {
            position: relative;
            display: flex;
            align-items: center;
            height: 38px;
            padding: 0 16px;
            font-size: 11px;
            font-weight: 700;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.15s;
            border-radius: 8px 8px 0 0;
            margin-right: 2px;
            white-space: nowrap;
            background-color: transparent;
            border: 1px solid transparent;
            border-bottom: none;
            min-width: 100px;
            max-width: 180px;
            text-transform: uppercase;
        }
        .chrome-tab:hover {
            background-color: rgba(30, 41, 59, 0.4);
            color: #f1f5f9;
        }
        .chrome-tab.active {
            background-color: #0f172a;
            color: #fbbf24;
            border-color: #1e293b;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.4);
            z-index: 10;
        }

        .tab-close {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            margin-left: 8px;
            border-radius: 4px;
            opacity: 0.4;
            transition: all 0.2s;
        }
        .tab-close:hover { background-color: #ef4444; color: white; opacity: 1; }

        .no-spinner::-webkit-outer-spin-button,
        .no-spinner::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .no-spinner { -moz-appearance: textfield; }

        input[type="number"]#trade-qty, 
        input[type="number"]#edit-qty {
            accent-color: #eab308;
            color-scheme: dark;
        }

        .page-view, .report-page-view { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .btn-toggle-active {
            background-color: #1e293b;
            color: #fbbf24;
            border: 1px solid rgba(234, 179, 8, 0.4);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="text-slate-200 overflow-hidden font-sans">

    <!-- AUTH CONTAINER -->
    <div id="auth-container" class="fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center p-4">
        <!-- LOGIN VIEW -->
        <div id="login-view" class="w-full max-w-md bg-slate-900 p-10 rounded-[2.5rem] shadow-2xl border border-slate-800">
            <div class="text-center mb-10">
                <div class="bg-yellow-500 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl shadow-yellow-500/10">
                    <i data-lucide="trending-up" class="text-slate-900 w-8 h-8"></i>
                </div>
                <h1 class="text-3xl font-black text-white tracking-tighter uppercase italic">Sign In</h1>
                <p class="text-slate-500 text-sm mt-2">Professional Commodity Tracking</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Mobile Number</label>
                    <input type="tel" id="login-username" required placeholder="Enter 10-digit number"
                           class="w-full px-5 py-4 bg-slate-800 border border-slate-700 rounded-2xl text-white font-bold outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Password</label>
                    <input type="password" id="login-password" required placeholder="••••••••"
                           class="w-full px-5 py-4 bg-slate-800 border border-slate-700 rounded-2xl text-white font-bold outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <p id="login-error" class="text-red-400 text-xs font-bold uppercase hidden"></p>
                <button type="submit" class="w-full py-5 bg-yellow-600 hover:bg-yellow-500 text-slate-950 font-black rounded-2xl shadow-xl transition transform active:scale-95 uppercase tracking-widest italic">
                    Enter Portal
                </button>
            </form>
            <p class="text-center text-sm text-slate-500 mt-10">
                New user? <a href="javascript:void(0)" id="show-register" class="text-blue-400 font-bold hover:underline">Create account</a>
            </p>
        </div>

        <!-- REGISTER VIEW -->
        <div id="register-view" class="w-full max-w-md bg-slate-900 p-10 rounded-[2.5rem] shadow-2xl border border-slate-800 hidden">
            <div class="text-center mb-10">
                <h1 class="text-3xl font-black text-white tracking-tighter uppercase italic">Create Account</h1>
                <p class="text-slate-500 text-sm mt-2">Join the professional trade network</p>
            </div>
            <form id="register-form" class="space-y-5">
                <div>
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Full Name</label>
                    <input type="text" id="register-name" required placeholder="Full Name"
                           class="w-full px-5 py-4 bg-slate-800 border border-slate-700 rounded-2xl text-white font-bold outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Mobile Number</label>
                    <input type="tel" id="register-username" required maxlength="10" placeholder="10-digit number"
                           class="w-full px-5 py-4 bg-slate-800 border border-slate-700 rounded-2xl text-white font-bold outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Password</label>
                    <input type="password" id="register-password" required minlength="6" placeholder="Min 6 characters"
                           class="w-full px-5 py-4 bg-slate-800 border border-slate-700 rounded-2xl text-white font-bold outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <p id="register-error" class="text-red-400 text-xs font-bold uppercase hidden"></p>
                <button type="submit" class="w-full py-5 bg-blue-600 hover:bg-blue-500 text-white font-black rounded-2xl shadow-xl transition transform active:scale-95 uppercase tracking-widest">
                    Create Profile
                </button>
            </form>
            <p class="text-center text-sm text-slate-500 mt-10">
                Registered? <a href="javascript:void(0)" id="show-login" class="text-yellow-500 font-bold hover:underline">Sign In</a>
            </p>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div id="main-app-container" class="flex h-screen overflow-hidden hidden">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="bg-slate-900 border-r border-slate-800 flex flex-col z-50">
            <div class="h-16 flex items-center justify-between px-5 border-b border-slate-800">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="bg-yellow-500 p-1.5 rounded-lg text-slate-900 flex-shrink-0 shadow-lg">
                        <i data-lucide="trending-up" class="w-5 h-5"></i>
                    </div>
                    <span class="text-lg font-black text-white tracking-tighter truncate uppercase italic font-sans">TradeTracker</span>
                </div>
                <!-- SIDEBAR HIDE BUTTON -->
                <button id="collapse-sidebar" title="Hide Sidebar" class="p-1.5 rounded-lg text-slate-600 hover:text-white hover:bg-slate-800 transition">
                    <i data-lucide="chevrons-left" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto py-6 px-4 space-y-8 no-scrollbar font-sans">
                <section>
                    <h3 class="px-2 text-[10px] font-black text-slate-600 uppercase tracking-widest mb-4">Operations</h3>
                    <div class="space-y-1">
                        <a href="#dashboard" class="sidebar-link group flex items-center px-3 py-2.5 text-sm font-medium rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition">
                            <i data-lucide="layout-dashboard" class="w-4 h-4 mr-3"></i> Dashboard
                        </a>
                        <a href="#buysell" class="sidebar-link group flex items-center px-3 py-2.5 text-sm font-medium rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition font-sans">
                            <i data-lucide="refresh-cw" class="w-4 h-4 mr-3 text-blue-400"></i> Buy / Sell
                        </a>
                    </div>
                </section>

                <section>
                    <h3 class="px-2 text-[10px] font-black text-slate-600 uppercase tracking-widest mb-4">Portfolio</h3>
                    <div class="space-y-1">
                        <a href="#report-overall" class="sidebar-link group flex items-center px-3 py-2.5 text-sm font-medium rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition">
                            <i data-lucide="bar-chart-3" class="w-4 h-4 mr-3 text-green-400"></i> Portfolio P&L
                        </a>
                        <div class="pt-4 pb-2 px-3 text-[9px] font-bold text-slate-700 uppercase tracking-widest">Detail Logs</div>
                        <div class="grid grid-cols-1 gap-1">
                            <a href="#report-gold_mini" class="sidebar-link flex items-center px-3 py-2 text-[11px] font-bold rounded-lg text-slate-500 hover:text-yellow-500 transition">Gold Mini</a>
                            <a href="#report-silver_mini" class="sidebar-link flex items-center px-3 py-2 text-[11px] font-bold rounded-lg text-slate-500 hover:text-slate-200 transition">Silver Mini</a>
                            <a href="#report-gold_1kg" class="sidebar-link flex items-center px-3 py-2 text-[11px] font-bold rounded-lg text-slate-500 hover:text-yellow-400 transition">Gold (1kg)</a>
                            <a href="#report-silver_30kg" class="sidebar-link flex items-center px-3 py-2 text-[11px] font-bold rounded-lg text-slate-500 hover:text-blue-400 transition">Silver (30kg)</a>
                        </div>
                    </div>
                </section>
            </div>

            <div class="p-4 border-t border-slate-800">
                <a href="#profile" class="sidebar-link flex items-center px-3 py-2.5 text-sm font-medium rounded-xl text-slate-400 hover:bg-slate-800 transition mb-2">
                    <i data-lucide="user-circle" class="w-4 h-4 mr-3"></i> Profile
                </a>
                <button id="sign-out-btn" class="w-full flex items-center px-3 py-2.5 text-sm font-medium text-red-500 hover:bg-red-500/10 rounded-xl transition font-sans font-bold">
                    <i data-lucide="log-out" class="w-4 h-4 mr-3"></i> Sign Out
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col min-w-0 bg-slate-950 overflow-hidden">
            
            <div id="tab-strip" class="h-10 bg-slate-950 flex items-end px-2 pt-1.5 overflow-x-auto no-scrollbar border-b border-slate-800 font-sans">
                <!-- Injected via JS -->
            </div>

            <header class="h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-4 sm:px-8">
                <div class="flex items-center gap-4">
                    <!-- EXPAND SIDEBAR BUTTON -->
                    <button id="expand-sidebar" title="Open Sidebar" class="p-2 rounded-lg bg-slate-800 text-slate-400 hover:text-white transition">
                        <i data-lucide="chevrons-right" class="w-5 h-5"></i>
                    </button>
                    <div class="flex flex-col">
                        <h2 id="topbar-title" class="text-lg font-black text-white tracking-tight uppercase italic leading-tight">Dashboard</h2>
                        <span class="text-[9px] text-slate-500 font-bold tracking-[0.3em] uppercase">Trade Analysis System</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-4 text-right">
                    <div class="hidden sm:flex flex-col text-right">
                        <span id="header-user-name" class="text-sm font-extrabold text-white">---</span>
                        <span id="header-user-phone" class="text-[9px] text-yellow-500 font-black uppercase tracking-tighter italic">Secured session</span>
                    </div>
                    <div id="user-initial-icon" class="w-10 h-10 rounded-xl bg-gradient-to-br from-yellow-400 to-yellow-600 flex items-center justify-center text-slate-900 font-black shadow-xl uppercase font-sans">?</div>
                </div>
            </header>

            <div id="content-scroller" class="flex-1 overflow-y-auto p-4 sm:p-8 bg-[#0f172a]">

                <!-- DASHBOARD VIEW -->
                <div id="dashboard-view" class="page-view space-y-6">
                    <div class="bg-slate-900 p-8 rounded-3xl border border-slate-800 shadow-2xl relative overflow-hidden group">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-12 gap-6">
                            <div class="flex items-center gap-3">
                                <div id="dash-comm-icon-bg" class="p-3 rounded-2xl bg-yellow-500 text-slate-900 shadow-lg shadow-yellow-500/10">
                                    <i id="dash-comm-icon" data-lucide="coins" class="w-6 h-6"></i>
                                </div>
                                <h2 id="dash-card-title" class="text-xl font-black text-white uppercase tracking-tight italic">Gold Mini (100g)</h2>
                            </div>

                            <!-- 4-WAY SWITCHER GROUP -->
                            <div class="flex flex-wrap bg-slate-950 p-1.5 rounded-2xl border border-slate-800 gap-1 shadow-inner">
                                <button data-val="gold_1kg" class="dash-switch px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest transition text-slate-600">Gold 1kg</button>
                                <button data-val="silver_30kg" class="dash-switch px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest transition text-slate-600">Silver 30kg</button>
                                <button data-val="gold_mini" class="dash-switch px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest transition btn-toggle-active">G Mini</button>
                                <button data-val="silver_mini" class="dash-switch px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest transition text-slate-600">S Mini</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 font-sans">
                            <div class="bg-slate-800/40 p-10 rounded-[2.5rem] border border-slate-700/50 shadow-inner">
                                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 italic">Weighted Purchase Basis</p>
                                <p id="dash-avg-buy" class="text-6xl font-black text-green-400 font-mono tracking-tighter">0.00</p>
                            </div>
                            <div class="bg-slate-800/40 p-10 rounded-[2.5rem] border border-slate-700/50 shadow-inner">
                                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 italic">Weighted Disposal Basis</p>
                                <p id="dash-avg-sell" class="text-6xl font-black text-red-400 font-mono tracking-tighter">0.00</p>
                            </div>
                        </div>

                        <div class="mt-12 flex justify-between items-center text-[10px] font-black text-slate-500 tracking-widest uppercase italic font-sans">
                            <span id="dash-trade-count">Loading session metrics...</span>
                            <span class="bg-yellow-500/10 text-yellow-500 px-4 py-1.5 rounded-xl border border-yellow-500/20 italic">Cloud Synchronized</span>
                        </div>
                    </div>
                </div>

                <!-- BUY / SELL VIEW -->
                <div id="buysell-view" class="page-view space-y-6 font-sans">
                    <div class="bg-slate-900 p-8 rounded-3xl border border-slate-800 shadow-2xl">
                        <div class="flex flex-col md:flex-row md:items-center justify-between mb-10 gap-6">
                            <div class="flex items-center gap-3">
                                <div id="buysell-icon-bg" class="p-3 rounded-2xl bg-yellow-500 text-slate-900 shadow-lg shadow-yellow-500/10">
                                    <i id="buysell-icon" data-lucide="coins" class="w-6 h-6"></i>
                                </div>
                                <h2 id="buysell-title" class="text-2xl font-black text-white tracking-tight uppercase italic font-sans">Gold Mini (100g)</h2>
                            </div>
                            
                            <!-- 4-WAY SWITCHER GROUP -->
                            <div class="flex flex-wrap bg-slate-950 p-1.5 rounded-2xl border border-slate-800 gap-1 shadow-inner">
                                <button data-val="gold_1kg" class="buysell-switch px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition text-slate-600">Gold 1kg</button>
                                <button data-val="silver_30kg" class="buysell-switch px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition text-slate-600">Silver 30kg</button>
                                <button data-val="gold_mini" class="buysell-switch px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition btn-toggle-active">G Mini</button>
                                <button data-val="silver_mini" class="buysell-switch px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition text-slate-600">S Mini</button>
                            </div>
                        </div>

                        <!-- 2-ROW PROFESSIONAL TRANSACTION FORM -->
                        <form id="combined-trade-form" class="space-y-4 bg-slate-950/50 p-8 rounded-[2rem] border border-slate-800 shadow-inner">
                            <!-- ROW 1 -->
                            <div class="flex flex-wrap items-end gap-6">
                                <div class="w-24">
                                    <label class="block text-[9px] font-black text-slate-500 uppercase tracking-widest mb-2 italic">Vch No.</label>
                                    <input type="text" id="trade-vch-no" readonly class="w-full px-3 py-3 bg-slate-900 border border-slate-700 rounded-xl text-yellow-500 font-black outline-none text-center text-sm font-mono cursor-not-allowed">
                                </div>
                                <div class="flex-1 min-w-[180px]">
                                    <label class="block text-[9px] font-black text-slate-500 uppercase tracking-widest mb-2 italic">Entry Date</label>
                                    <input type="date" id="trade-date" required class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white font-bold outline-none focus:ring-1 focus:ring-blue-500 text-xs">
                                </div>
                                <div class="flex-1 min-w-[140px]">
                                    <label class="block text-[9px] font-black text-slate-500 uppercase tracking-widest mb-2 italic">Execution Time</label>
                                    <input type="time" id="trade-time" required class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white font-bold outline-none focus:ring-1 focus:ring-blue-500 text-xs">
                                </div>
                            </div>

                            <!-- ROW 2 -->
                            <div class="flex flex-wrap items-end gap-6 pt-4 border-t border-slate-800/30">
                                <div class="w-24">
                                    <label class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2 italic font-sans">Qty.</label>
                                    <input type="number" id="trade-qty" value="1" min="1" step="1" required class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white font-black outline-none focus:ring-1 focus:ring-blue-500 text-sm text-center">
                                </div>
                                <div class="flex-1 min-w-[150px]">
                                    <label id="buy-rate-label" class="block text-[9px] font-black text-green-500 uppercase tracking-widest mb-2 italic font-sans">Buy Basis</label>
                                    <input type="number" id="trade-buy-amount" placeholder="0.00" step="any" min="0" class="no-spinner w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white font-bold outline-none focus:ring-1 focus:ring-green-500 text-sm font-mono tracking-tighter">
                                </div>
                                <div class="flex-1 min-w-[150px]">
                                    <label id="sell-rate-label" class="block text-[9px] font-black text-red-500 uppercase tracking-widest mb-2 italic font-sans">Sell Basis</label>
                                    <input type="number" id="trade-sell-amount" placeholder="0.00" step="any" min="0" class="no-spinner w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white font-bold outline-none focus:ring-1 focus:ring-red-500 text-sm font-mono tracking-tighter">
                                </div>
                                <div class="w-full lg:w-auto">
                                    <button type="submit" id="trade-submit-button" class="w-full lg:px-16 py-4 bg-yellow-600 hover:bg-yellow-500 text-slate-950 font-black rounded-xl shadow-xl transition transform active:scale-95 text-[10px] uppercase tracking-widest font-sans">COMMIT LOG</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="bg-slate-900 rounded-3xl border border-slate-800 overflow-hidden shadow-2xl">
                        <div class="px-8 py-4 border-b border-slate-800 bg-slate-800/30 font-black text-[10px] text-slate-400 uppercase tracking-widest italic font-sans">Operational Journal Registry</div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-950/50">
                                    <tr class="text-[10px] font-black text-slate-500 uppercase tracking-widest font-sans">
                                        <th class="px-8 py-4 text-left">Vch.</th>
                                        <th class="px-8 py-4 text-left">Timestamp</th>
                                        <th class="px-8 py-4 text-center">Lots</th>
                                        <th id="table-buy-header" class="px-8 py-4 text-left text-green-500">Buy Basis</th>
                                        <th id="table-sell-header" class="px-8 py-4 text-left text-red-500">Sell Basis</th>
                                        <th class="px-8 py-4 text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="trade-history-body" class="divide-y divide-slate-800 font-mono italic"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- REPORTS VIEW -->
                <div id="report-view" class="page-view space-y-8 font-sans">
                    <div id="report-overall-view" class="report-page-view bg-slate-900 p-8 rounded-3xl border border-slate-800 shadow-2xl">
                        <h2 class="text-2xl font-black text-white mb-10 flex items-center gap-4 italic uppercase tracking-tighter">Consolidated Portfolio audit</h2>
                        <div class="overflow-hidden rounded-2xl border border-slate-800 shadow-inner">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-800/80 text-[10px] font-black text-slate-500 uppercase tracking-widest font-mono font-sans">
                                    <tr>
                                        <th class="px-8 py-6 text-left font-sans">Cycle</th>
                                        <th class="px-8 py-6 text-left text-yellow-600">G. Mini</th>
                                        <th class="px-8 py-6 text-left text-slate-400">S. Mini</th>
                                        <th class="px-8 py-6 text-left text-yellow-400">Gold 1kg</th>
                                        <th class="px-8 py-6 text-left text-blue-400">Silver 30kg</th>
                                        <th class="px-8 py-6 text-right text-white font-sans">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="pl-report-body" class="divide-y divide-slate-800 italic"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Individual Reports -->
                    <div id="report-gold_mini-view" class="report-page-view bg-slate-900 p-12 rounded-[3rem] border border-slate-800 shadow-2xl text-center">
                         <h2 class="text-2xl font-black text-yellow-500 mb-10 uppercase tracking-tighter italic font-sans">Gold Mini Audit</h2>
                         <div id="gold_mini-pl-report" class="pl-details-button text-7xl font-black text-white cursor-pointer hover:underline inline-block font-mono tracking-tighter" data-commodity="gold_mini" data-week="all">0.00</div>
                    </div>
                    <div id="report-silver_mini-view" class="report-page-view bg-slate-900 p-12 rounded-[3rem] border border-slate-800 shadow-2xl text-center">
                         <h2 class="text-2xl font-black text-slate-400 mb-10 uppercase tracking-tighter italic font-sans">Silver Mini Audit</h2>
                         <div id="silver_mini-pl-report" class="pl-details-button text-7xl font-black text-white cursor-pointer hover:underline inline-block font-mono tracking-tighter" data-commodity="silver_mini" data-week="all">0.00</div>
                    </div>
                    <div id="report-gold_1kg-view" class="report-page-view bg-slate-900 p-12 rounded-[3rem] border border-slate-800 shadow-2xl text-center">
                         <h2 class="text-2xl font-black text-yellow-400 mb-10 uppercase tracking-tighter italic underline decoration-yellow-500 decoration-4 underline-offset-8 font-sans">Gold 1kg Portfolio</h2>
                         <div id="gold_1kg-pl-report" class="pl-details-button text-8xl font-black text-white cursor-pointer hover:underline inline-block font-mono tracking-tighter" data-commodity="gold_1kg" data-week="all">0.00</div>
                    </div>
                    <div id="report-silver_30kg-view" class="report-page-view bg-slate-900 p-12 rounded-[3rem] border border-slate-800 shadow-2xl text-center">
                         <h2 class="text-2xl font-black text-blue-400 mb-10 uppercase tracking-tighter italic underline decoration-blue-500 decoration-4 underline-offset-8 font-sans">Silver 30kg Portfolio</h2>
                         <div id="silver_30kg-pl-report" class="pl-details-button text-8xl font-black text-white cursor-pointer hover:underline inline-block font-mono tracking-tighter" data-commodity="silver_30kg" data-week="all">0.00</div>
                    </div>
                </div>

                <!-- PROFILE -->
                <div id="profile-view" class="page-view font-sans">
                    <div class="bg-slate-900 p-10 rounded-[3rem] border border-slate-800 shadow-2xl max-w-2xl mx-auto">
                        <h2 class="text-2xl font-black text-white mb-10 uppercase italic tracking-tighter">System Configuration</h2>
                        <form id="profile-details-form" class="space-y-6">
                            <input type="text" id="profile-full-name" placeholder="Full Identity" class="w-full px-6 py-4 bg-slate-800 border border-slate-700 rounded-2xl text-white font-bold outline-none focus:ring-1 focus:ring-blue-500 transition shadow-inner">
                            <button type="submit" class="w-full py-5 px-4 bg-blue-600 hover:bg-blue-500 text-white font-black rounded-2xl italic tracking-widest uppercase shadow-lg shadow-blue-600/10 transition">Save Profile Changes</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="pl-details-modal" class="fixed inset-0 bg-black/95 backdrop-blur-md hidden items-center justify-center p-4 z-[200]">
        <div class="bg-slate-900 p-12 rounded-[3rem] shadow-2xl max-w-4xl w-full border border-slate-800 font-sans">
            <h3 id="pl-details-title" class="text-2xl font-black text-white mb-10 uppercase italic underline decoration-yellow-500 underline-offset-8 tracking-tighter">Audit Performance Detail</h3>
            <div id="pl-details-content" class="max-h-[50vh] overflow-y-auto no-scrollbar font-mono text-xs italic tracking-tighter"></div>
            <button id="pl-details-close-button" class="mt-10 w-full py-5 bg-slate-800 text-white font-black rounded-2xl uppercase tracking-widest transition hover:bg-slate-700">Dismiss Detail</button>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black/90 hidden items-center justify-center p-4 z-[300]">
        <div class="bg-slate-900 p-10 rounded-[2.5rem] max-w-sm w-full border border-slate-800 shadow-2xl font-sans">
            <form id="edit-trade-form" class="space-y-6">
                <h3 class="text-xl font-black text-white uppercase italic tracking-tighter mb-4 font-sans text-center">Modify Entry</h3>
                <input type="hidden" id="edit-trade-id">
                <div>
                    <label class="text-[10px] font-black text-slate-500 mb-1.5 block uppercase tracking-widest">Vch No.</label>
                    <input type="text" id="edit-vch-no" class="w-full px-5 py-3.5 bg-slate-800 border border-slate-700 rounded-2xl text-white font-bold outline-none font-mono">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 mb-1.5 block uppercase tracking-widest italic font-sans">Lots</label>
                    <input type="number" id="edit-qty" min="1" step="1" class="w-full px-5 py-3.5 bg-slate-800 border border-slate-700 rounded-2xl text-white font-bold outline-none font-mono">
                </div>
                <div>
                    <label class="text-[10px] font-black text-green-500 mb-1.5 block uppercase tracking-widest italic font-sans">Buy Rate</label>
                    <input type="number" id="edit-buy-amount" step="any" class="no-spinner w-full px-5 py-3.5 bg-slate-800 border border-slate-700 rounded-2xl text-white font-bold outline-none font-mono tracking-tighter">
                </div>
                <div>
                    <label class="text-[10px] font-black text-red-500 mb-1.5 block uppercase tracking-widest italic font-sans">Sell Rate</label>
                    <input type="number" id="edit-sell-amount" step="any" class="no-spinner w-full px-5 py-3.5 bg-slate-800 border border-slate-700 rounded-2xl text-white font-bold outline-none font-mono tracking-tighter">
                </div>
                <div class="flex gap-4 pt-6">
                    <button type="button" id="edit-cancel-button" class="w-1/2 py-4 bg-slate-800 text-white font-black rounded-2xl text-[10px] uppercase tracking-widest">Cancel</button>
                    <button type="submit" class="w-1/2 py-4 bg-blue-600 text-white font-black rounded-2xl text-[10px] uppercase transition shadow-lg shadow-blue-600/10">Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, deleteDoc, updateDoc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAYy9FONBnwilc2f3WdTCGFQ2-W3jQvE3E",
            authDomain: "parth-trading.firebaseapp.com",
            projectId: "parth-trading",
            storageBucket: "parth-trading.firebasestorage.app",
            messagingSenderId: "629101446151",
            appId: "1:629101446151:web:d91110064a8889497916a2",
            measurementId: "G-7JQ523ETHN"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = null;
        let allTradesData = [];
        
        let dashKey = 'gold_mini';
        let buysellKey = 'gold_mini';
        
        let openTabs = ['#dashboard'];
        let activeTabHash = '#dashboard';

        const PHONE_SUFFIX = "@trade-tracker.app";
        const el = (id) => document.getElementById(id);
        const getCurrentTime = () => new Date().toTimeString().substring(0, 5);
        const getMondayOfWeek = (dateStr) => {
            if(!dateStr) return '';
            const d = new Date(dateStr); d.setHours(0,0,0,0);
            const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff)).toISOString().split('T')[0];
        };

        const getNextVchNo = () => {
            if (allTradesData.length === 0) return 1;
            const numbers = allTradesData.map(t => parseInt(t.vchNo) || 0);
            return Math.max(0, ...numbers) + 1;
        };

        const multipliers = {
            'gold_mini': 10, 'silver_mini': 5, 'gold_1kg': 100, 'silver_30kg': 30
        };

        const calculateFifoPL = (trades, commodity) => {
            let realizedPL = 0, pairs = [];
            let longQ = [], shortQ = [];
            const multiplier = multipliers[commodity] || 1;
            const commissionPerUnit = 300;
            
            const sorted = [...trades].sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return (a.time || "").localeCompare(b.time || "");
            });

            sorted.forEach(t => {
                const buy = t.buyAmount || 0, sell = t.sellAmount || 0, qty = t.qty || 1, vch = t.vchNo || '---';
                for (let i = 0; i < qty; i++) {
                    if (buy > 0) {
                        if (shortQ.length > 0) {
                            const open = shortQ.shift();
                            const p = (open.price - buy) * multiplier;
                            realizedPL += (p - commissionPerUnit);
                            pairs.push({ buy, sell: open.price, profit: p, comm: commissionPerUnit, net: p - commissionPerUnit, vchIn: vch, vchOut: open.vch });
                        } else { longQ.push({ price: buy, vch: vch }); }
                    } else if (sell > 0) {
                        if (longQ.length > 0) {
                            const open = longQ.shift();
                            const p = (sell - open.price) * multiplier;
                            realizedPL += (p - commissionPerUnit);
                            pairs.push({ buy: open.price, sell: sell, profit: p, comm: commissionPerUnit, net: p - commissionPerUnit, vchIn: open.vch, vchOut: vch });
                        } else { shortQ.push({ price: sell, vch: vch }); }
                    }
                }
            });
            return { totalPL: realizedPL, pairs, pairCount: pairs.length };
        };

        const updateAllUI = () => {
            allTradesData.sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return (a.time || "").localeCompare(b.time || "");
            });

            el('trade-vch-no').value = getNextVchNo();

            const currentMon = getMondayOfWeek(new Date().toISOString().split('T')[0]);

            // Dash Update
            const dashTrades = allTradesData.filter(t => t.commodity === dashKey && getMondayOfWeek(t.date) === currentMon);
            let dB = 0, dS = 0, dBC = 0, dSC = 0;
            dashTrades.forEach(t => { 
                if(t.buyAmount > 0){ dB+=(t.buyAmount*t.qty); dBC+=t.qty; } 
                if(t.sellAmount > 0){ dS+=(t.sellAmount*t.qty); dSC+=t.qty; } 
            });
            el('dash-avg-buy').textContent = (dBC > 0 ? dB/dBC : 0).toFixed(2);
            el('dash-avg-sell').textContent = (dSC > 0 ? dS/dSC : 0).toFixed(2);
            el('dash-trade-count').textContent = `Activity Level: ${dBC + dSC} lots logged this cycle.`;

            // Individual Reports Update
            ['gold_mini', 'silver_mini', 'gold_1kg', 'silver_30kg'].forEach(c => {
                const trades = allTradesData.filter(t => t.commodity === c);
                const plResult = calculateFifoPL(trades, c);
                if(el(`${c}-pl-report`)) {
                    el(`${c}-pl-report`).textContent = plResult.totalPL.toLocaleString('en-IN', {minimumFractionDigits: 2});
                    el(`${c}-pl-report`).classList.toggle('text-green-400', plResult.totalPL > 0);
                    el(`${c}-pl-report`).classList.toggle('text-red-500', plResult.totalPL < 0);
                }
            });

            renderOverallReport(); renderBuySellHistory();
        };

        const renderBuySellHistory = () => {
            const body = el('trade-history-body'), currentMon = getMondayOfWeek(new Date().toISOString().split('T')[0]);
            const filtered = allTradesData.filter(t => t.commodity === buysellKey && getMondayOfWeek(t.date) === currentMon);
            body.innerHTML = '';
            filtered.forEach(trade => {
                const row = document.createElement('tr'); row.className = 'hover:bg-slate-800/40 transition group font-sans';
                row.innerHTML = `<td class="px-8 py-4 text-[10px] text-yellow-500 font-black italic">#${trade.vchNo || '0'}</td>
                    <td class="px-8 py-4 text-xs text-slate-300 font-bold tracking-tighter font-sans">${trade.date} <span class="text-slate-600 font-normal italic ml-1 font-sans">@${trade.time || ''}</span></td>
                    <td class="px-8 py-4 text-center text-slate-100 font-black">${trade.qty || 1}</td>
                    <td class="px-8 py-4 text-sm text-green-500 font-black tracking-tighter font-mono">${(trade.buyAmount || 0).toFixed(2)}</td>
                    <td class="px-8 py-4 text-sm text-red-500 font-black tracking-tighter font-mono">${(trade.sellAmount || 0).toFixed(2)}</td>
                    <td class="px-8 py-4 text-right flex justify-end gap-3 opacity-30 group-hover:opacity-100 transition">
                        <button class="edit-btn p-1 hover:text-white" data-id="${trade.id}" data-vch="${trade.vchNo}" data-qty="${trade.qty}" data-date="${trade.date}" data-time="${trade.time || ''}" data-buy="${trade.buyAmount}" data-sell="${trade.sellAmount}"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        <button class="delete-btn p-1 hover:text-red-500" data-id="${trade.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>`;
                body.appendChild(row);
            });
            lucide.createIcons();
        };

        const renderOverallReport = () => {
            const body = el('pl-report-body'); body.innerHTML = '';
            const weeklyData = {}, weekMap = {}; let wc = 0;
            allTradesData.forEach(t => {
                const mon = getMondayOfWeek(t.date); if(!weekMap[mon]){ wc++; weekMap[mon] = wc; }
                const wn = weekMap[mon]; if(!weeklyData[wn]) weeklyData[wn] = { gold_mini: [], silver_mini: [], gold_1kg: [], silver_30kg: [] };
                weeklyData[wn][t.commodity].push(t);
            });
            Object.keys(weeklyData).sort((a,b)=>a-b).forEach(wn => {
                const gMPL = calculateFifoPL(weeklyData[wn].gold_mini, 'gold_mini').totalPL;
                const sMPL = calculateFifoPL(weeklyData[wn].silver_mini, 'silver_mini').totalPL;
                const gFPL = calculateFifoPL(weeklyData[wn].gold_1kg, 'gold_1kg').totalPL;
                const sFPL = calculateFifoPL(weeklyData[wn].silver_30kg, 'silver_30kg').totalPL;
                const total = gMPL + sMPL + gFPL + sFPL;
                const row = body.insertRow(); row.className = 'hover:bg-slate-800/50 transition text-slate-300 font-mono italic font-bold font-sans';
                row.innerHTML = `<td class="px-8 py-5 text-xs text-yellow-500 uppercase font-black italic font-sans">Week ${wn} Snap</td>
                    <td class="pl-details-button cursor-pointer hover:underline text-[11px]" data-commodity="gold_mini" data-week="${wn}">${gMPL.toFixed(2)}</td>
                    <td class="pl-details-button cursor-pointer hover:underline text-[11px]" data-commodity="silver_mini" data-week="${wn}">${sMPL.toFixed(2)}</td>
                    <td class="pl-details-button cursor-pointer hover:underline text-[11px]" data-commodity="gold_1kg" data-week="${wn}">${gFPL.toFixed(2)}</td>
                    <td class="pl-details-button cursor-pointer hover:underline text-[11px]" data-commodity="silver_30kg" data-week="${wn}">${sFPL.toFixed(2)}</td>
                    <td class="px-8 py-5 text-right font-black text-white italic tracking-tighter">${total.toFixed(2)}</td>`;
            });
        };

        const renderTabs = () => {
            const strip = el('tab-strip'); strip.innerHTML = '';
            const names = { '#dashboard': 'Dashboard', '#buysell': 'Operations', '#report-overall': 'P&L Analysis', '#report-gold_mini': 'Gold Mini', '#report-silver_mini': 'Silver Mini', '#report-gold_1kg': 'Gold 1kg', '#report-silver_30kg': 'Silver 30kg', '#profile': 'Config' };
            openTabs.forEach(h => {
                const tab = document.createElement('div');
                tab.className = `chrome-tab ${activeTabHash.startsWith(h) ? 'active' : ''}`;
                tab.innerHTML = `<span>${names[h] || 'Log'}</span>`;
                if(h !== '#dashboard'){
                    const closeBtn = document.createElement('span'); closeBtn.className = 'tab-close'; closeBtn.innerHTML = '&times;';
                    closeBtn.onclick = (e) => { e.stopPropagation(); const idx = openTabs.indexOf(h); openTabs.splice(idx, 1); if(activeTabHash.startsWith(h)) window.location.hash = openTabs[Math.max(0, idx-1)]; else renderTabs(); };
                    tab.appendChild(closeBtn);
                }
                tab.onclick = () => window.location.hash = h; strip.appendChild(tab);
            });
            lucide.createIcons();
        };

        const navigateTo = (h) => {
            const hash = h || '#dashboard'; activeTabHash = hash;
            const root = hash.split('-')[0].includes('report') ? '#report-' + (hash.split('-')[1] || 'overall') : hash;
            if(!openTabs.includes(root)) openTabs.push(root);
            renderTabs();
            const views = ['dashboard', 'buysell', 'report', 'profile'];
            const activeView = views.find(v => hash.startsWith('#'+v)) || 'dashboard';
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.toggle('active', hash.startsWith(l.getAttribute('href'))));
            views.forEach(v => el(`${v}-view`).style.display = activeView === v ? 'block' : 'none');
            if(activeView === 'report'){
                const sub = hash.split('-')[1] || 'overall';
                const reportIds = ['overall', 'gold_mini', 'silver_mini', 'gold_1kg', 'silver_30kg'];
                reportIds.forEach(id => {
                    const view = el(`report-${id}-view`);
                    if(view) view.style.display = sub === id ? 'block' : 'none';
                });
            }
            el('topbar-title').textContent = activeView.toUpperCase();
        };

        const setStatus = (msg, type = 'info') => {
            const statusEl = el('trade-status-msg'); statusEl.textContent = msg;
            statusEl.className = `mt-4 text-[10px] font-bold uppercase ${type === 'error' ? 'text-red-400' : 'text-green-400'}`;
            statusEl.classList.remove('hidden'); setTimeout(() => statusEl.classList.add('hidden'), 4000);
        };

        document.addEventListener('DOMContentLoaded', () => {
            el('trade-date').value = new Date().toISOString().split('T')[0];
            el('trade-time').value = getCurrentTime();
            lucide.createIcons();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    el('auth-container').classList.add('hidden');
                    el('main-app-container').classList.remove('hidden');
                    
                    const pDoc = await getDoc(doc(db, `artifacts/${appId}/user_profiles/${userId}`));
                    const data = pDoc.exists() ? pDoc.data() : { fullName: "User" };
                    el('header-user-name').textContent = data.fullName;
                    el('user-initial-icon').textContent = data.fullName[0].toUpperCase();

                    onSnapshot(query(collection(db, `artifacts/${appId}/users/${userId}/commodity_trades`)), (snap) => {
                        allTradesData = []; snap.forEach(doc => allTradesData.push({ id: doc.id, ...doc.data() }));
                        updateAllUI();
                    });
                } else {
                    el('auth-container').classList.remove('hidden');
                    el('main-app-container').classList.add('hidden');
                }
                navigateTo(window.location.hash);
            });

            // LOGIN
            el('login-form').onsubmit = async (e) => {
                e.preventDefault();
                const u = el('login-username').value;
                const p = el('login-password').value;
                try {
                    await signInWithEmailAndPassword(auth, u + PHONE_SUFFIX, p);
                } catch (err) {
                    el('login-error').textContent = "Incorrect Details.";
                    el('login-error').classList.remove('hidden');
                }
            };

            // REGISTER
            el('register-form').onsubmit = async (e) => {
                e.preventDefault();
                const n = el('register-name').value;
                const u = el('register-username').value;
                const p = el('register-password').value;
                try {
                    const cred = await createUserWithEmailAndPassword(auth, u + PHONE_SUFFIX, p);
                    await setDoc(doc(db, `artifacts/${appId}/user_profiles/${cred.user.uid}`), { fullName: n });
                } catch (err) {
                    el('register-error').textContent = err.message;
                    el('register-error').classList.remove('hidden');
                }
            };

            el('show-register').onclick = () => { el('login-view').classList.add('hidden'); el('register-view').classList.remove('hidden'); };
            el('show-login').onclick = () => { el('register-view').classList.add('hidden'); el('login-view').classList.remove('hidden'); };
            el('sign-out-btn').onclick = () => signOut(auth);

            // Dashboard Switch Marks
            document.querySelectorAll('.dash-switch').forEach(btn => {
                btn.onclick = () => {
                    dashKey = btn.dataset.val;
                    document.querySelectorAll('.dash-switch').forEach(b => b.className = "dash-switch px-4 py-2 rounded-xl text-[9px] font-black uppercase transition text-slate-600 hover:text-slate-400 font-sans");
                    btn.className = "dash-switch px-4 py-2 rounded-xl text-[9px] font-black uppercase transition btn-toggle-active font-sans";
                    const meta = {
                        'gold_mini': { title: "Gold Mini (100g)", icon: "coins", bg: "bg-yellow-500" },
                        'silver_mini': { title: "Silver Mini (5kg)", icon: "database", bg: "bg-slate-500" },
                        'gold_1kg': { title: "Gold Professional (1kg)", icon: "coins", bg: "bg-yellow-400" },
                        'silver_30kg': { title: "Silver Professional (30kg)", icon: "database", bg: "bg-blue-500" }
                    }[dashKey];
                    el('dash-card-title').textContent = meta.title;
                    el('dash-comm-icon-bg').className = `p-3 rounded-2xl ${meta.bg} text-slate-900 transition-all shadow-lg`;
                    el('dash-comm-icon').setAttribute('data-lucide', meta.icon);
                    lucide.createIcons(); updateAllUI();
                };
            });

            // BuySell Switch Marks
            document.querySelectorAll('.buysell-switch').forEach(btn => {
                btn.onclick = () => {
                    buysellKey = btn.dataset.val;
                    document.querySelectorAll('.buysell-switch').forEach(b => b.className = "buysell-switch px-4 py-2 rounded-xl text-[10px] font-black uppercase transition text-slate-600 hover:text-slate-400 font-sans");
                    btn.className = "buysell-switch px-4 py-2 rounded-xl text-[10px] font-black uppercase transition btn-toggle-active font-sans";
                    const meta = {
                        'gold_mini': { title: "Gold Mini (100g)", icon: "coins", bg: "bg-yellow-500", label: "Rate (10g)" },
                        'silver_mini': { title: "Silver Mini (5kg)", icon: "database", bg: "bg-slate-500", label: "Rate (1kg)" },
                        'gold_1kg': { title: "Gold Professional (1kg)", icon: "coins", bg: "bg-yellow-400", label: "Rate (10g)" },
                        'silver_30kg': { title: "Silver Professional (30kg)", icon: "database", bg: "bg-blue-500", label: "Rate (1kg)" }
                    }[buysellKey];
                    el('buysell-title').textContent = meta.title;
                    el('buysell-icon-bg').className = `p-3 rounded-2xl ${meta.bg} text-slate-900 transition-all shadow-lg`;
                    el('buysell-icon').setAttribute('data-lucide', meta.icon);
                    el('buy-rate-label').textContent = (buysellKey.includes('gold') ? 'Purchase Rate (10g)' : 'Purchase Rate (1kg)');
                    el('sell-rate-label').textContent = (buysellKey.includes('gold') ? 'Disposal Rate (10g)' : 'Disposal Rate (1kg)');
                    lucide.createIcons(); updateAllUI();
                };
            });

            el('combined-trade-form').onsubmit = async (e) => {
                e.preventDefault();
                const d = el('trade-date').value, t = el('trade-time').value, b = parseFloat(el('trade-buy-amount').value || 0), s = parseFloat(el('trade-sell-amount').value || 0), v = el('trade-vch-no').value, q = parseInt(el('trade-qty').value || 1);
                if(b === 0 && s === 0) return;
                const btn = el('trade-submit-button'); btn.disabled = true; btn.textContent = "SAVING...";
                try {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/commodity_trades`), { date: d, time: t, vchNo: v, buyAmount: b, sellAmount: s, qty: q, commodity: buysellKey, timestamp: serverTimestamp() });
                    el('combined-trade-form').reset(); 
                    el('trade-date').value = new Date().toISOString().split('T')[0]; el('trade-time').value = getCurrentTime(); el('trade-qty').value = "1";
                    setStatus("Transaction Logged");
                } catch(error) { setStatus("Sync Failed", "error"); }
                finally { btn.disabled = false; btn.textContent = "SAVE TRANSACTION"; }
            };

            document.addEventListener('click', (e) => {
                const btn = e.target.closest('button'), plBtn = e.target.closest('.pl-details-button');
                if(btn && btn.classList.contains('edit-btn')) { el('edit-trade-id').value = btn.dataset.id; el('edit-vch-no').value = btn.dataset.vch; el('edit-qty').value = btn.dataset.qty; el('edit-date').value = btn.dataset.date; el('edit-buy-amount').value = btn.dataset.buy; el('edit-sell-amount').value = btn.dataset.sell; el('edit-modal').classList.remove('hidden'); el('edit-modal').classList.add('flex'); }
                if(btn && btn.classList.contains('delete-btn')) deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/commodity_trades`, btn.dataset.id));
                if(plBtn) {
                    let filtered = []; const weekMap = {}; let wc = 0;
                    if (plBtn.dataset.week === 'all') filtered = allTradesData;
                    else { allTradesData.forEach(t => { const m = getMondayOfWeek(t.date); if(!weekMap[m]){ wc++; weekMap[m] = wc.toString(); } if(weekMap[m] === plBtn.dataset.week) filtered.push(t); }); }
                    let html = '', tPL = 0;
                    const build = (trades, c) => {
                        const res = calculateFifoPL(trades, c); tPL += res.totalPL;
                        if (res.pairs.length === 0) return '';
                        let h = `<div class="mb-12"><h4 class="text-[10px] font-black uppercase text-yellow-500 mb-6 italic underline decoration-yellow-500/20 underline-offset-4">${c} Details</h4>`;
                        h += `<table class="w-full text-[10px] mb-4 uppercase font-bold tracking-widest font-sans"><thead class="text-slate-600 border-b border-slate-800 font-sans"><tr><th class="px-3 py-4 text-left">Vch# Match</th><th class="px-3 py-4 text-left">In / Out</th><th class="px-3 py-4 text-right">Net P&L</th></tr></thead><tbody class="divide-y divide-slate-800 font-mono font-black italic">`;
                        res.pairs.forEach(p => { h += `<tr><td class="px-3 py-5 text-slate-500 font-sans tracking-normal">#${p.vchIn}/${p.vchOut}</td><td class="px-3 py-5 text-slate-300 font-sans tracking-tighter">${p.buy.toFixed(2)} / ${p.sell.toFixed(2)}</td><td class="px-3 py-5 text-right text-white font-sans font-black italic tracking-tighter">${p.net.toFixed(2)}</td></tr>`; });
                        return h + '</tbody></table></div>';
                    };
                    const cms = ['gold_mini', 'silver_mini', 'gold_1kg', 'silver_30kg'];
                    if (plBtn.dataset.commodity === 'all') cms.forEach(c => html += build(filtered.filter(t => t.commodity === c), c));
                    else html += build(filtered.filter(t => t.commodity === plBtn.dataset.commodity), plBtn.dataset.commodity);
                    el('pl-details-content').innerHTML = html; el('pl-details-modal').classList.remove('hidden'); el('pl-details-modal').classList.add('flex');
                }
            });

            el('edit-trade-form').onsubmit = async (e) => {
                e.preventDefault();
                await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/commodity_trades`, el('edit-trade-id').value), { vchNo: el('edit-vch-no').value, qty: parseInt(el('edit-qty').value || 1), buyAmount: parseFloat(el('edit-buy-amount').value || 0), sellAmount: parseFloat(el('edit-sell-amount').value || 0) });
                el('edit-modal').classList.add('hidden');
            };

            el('collapse-sidebar').onclick = () => document.body.classList.add('sidebar-hidden');
            el('expand-sidebar').onclick = () => document.body.classList.remove('sidebar-hidden');
            el('pl-details-close-button').onclick = () => el('pl-details-modal').classList.add('hidden');
            el('edit-cancel-button').onclick = () => el('edit-modal').classList.add('hidden');
            window.addEventListener('hashchange', () => navigateTo(window.location.hash));
            lucide.createIcons();
        });
    </script>
</body>
</html>